<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Patient Survey System</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body style="font-family: 'Frutiger W01', Arial, sans-serif; font-size: 14pt; color: #231f20; background-color: #f0f4f5; margin: 0; padding: 0;">
    <header style="background-color: #005eb8; padding: 12px 0;">
      <div style="max-width: 960px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; min-height: 80px;">
        
        <!-- Left: Page title -->
        <div style="color: white; font-weight: bold; font-size: 28px;">
          Patient Experience Survey
        </div>
    
        <!-- Right: Inline recreated NHS-style logo -->
        <div style="display: flex; flex-direction: column; align-items: flex-end; color: white;">
          
          <!-- NHS box with tighter crop and heavier text -->
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 22" style="height: 26px; width: auto; margin-bottom: 4px;">
            <!-- Tight white box -->
            <rect x="0" y="0" width="60" height="22" fill="white" rx="1" ry="1" />
            <!-- Bold, thick, italic blue NHS text -->
            <text x="50%" y="72%" text-anchor="middle"
                  font-family="Arial Black, Arial, Helvetica, sans-serif"
                  font-weight="900"
                  font-size="17"
                  fill="#005eb8"
                  letter-spacing="0.3"
                  transform="skewX(-12) scale(1.05, 1.08)">
              NHS
            </text>
          </svg>
    
          <!-- Hospital trust text -->
          <div style="text-align: right; font-weight: bold; line-height: 1.1;">
            <div style="font-size: 13px;">The Princess Alexandra</div>
            <div style="font-size: 13px;">Hospital</div>
            <div style="font-size: 13px;">NHS Trust</div>
          </div>
    
        </div>
    
      </div>
    </header>


    <div style="background-color: #ffffff; padding: 20px; margin: 0 -10px;">
        <div style="max-width: 960px; margin: 0 auto; padding: 20px;">
            <div id="loading" style="padding: 24px; text-align: center; font-size: 14pt;">Loading survey questions...</div>
            
            <form id="surveyForm" style="margin-bottom: 40px; display: none;">
                <div id="questionsContainer"></div>
                
                <div style="text-align: right; margin-top: 30px; margin-bottom: 20px;">
                    <button type="submit" style="
                        background-color: #007f3b;
                        color: #ffffff;
                        border: none;
                        border-radius: 4px;
                        box-shadow: 0 4px 0 #00401e;
                        padding: 12px 24px;
                        font-size: 16px;
                        font-weight: bold;
                        cursor: pointer;
                        outline: none;
                        font-family: 'Frutiger W01', Arial, sans-serif;
                    " onmouseover="this.style.backgroundColor='#00662f'" 
                    onmouseout="this.style.backgroundColor='#007f3b'"
                    onmousedown="this.style.backgroundColor='#00401e'; this.style.boxShadow='none'; this.style.transform='translateY(4px)'" 
                    onmouseup="this.style.backgroundColor='#00662f'; this.style.boxShadow='0 4px 0 #00401e'; this.style.transform='translateY(0)'">
                        Submit Survey
                    </button>
                </div>
            </form>

            <div id="successMessage" style="background-color: #007f3b; color: #ffffff; padding: 16px; margin-bottom: 32px; border-radius: 4px; font-weight: bold; display: none;" role="alert">
                Thank you for completing the survey! Your feedback has been recorded.
            </div>

            <div id="errorMessage" style="background-color: #8A1538; color: #ffffff; padding: 16px; margin-bottom: 32px; border-radius: 4px; font-weight: bold; display: none;" role="alert">
                There was an error submitting your survey. Please try again.
            </div>

            <div style="margin-top: 40px; padding-top: 24px; border-top: 1px solid #E8EDEE;">
                <a href="/api/questions" style="color: #005eb8; text-decoration: underline; margin-right: 24px; font-weight: bold;" 
                   onmouseover="this.style.color='#7C2855'; this.style.textDecoration='none'" 
                   onmouseout="this.style.color='#005eb8'; this.style.textDecoration='underline'">View Questions (JSON)</a>
                <a href="/api/responses" style="color: #005eb8; text-decoration: underline; margin-right: 24px; font-weight: bold;"
                   onmouseover="this.style.color='#7C2855'; this.style.textDecoration='none'" 
                   onmouseout="this.style.color='#005eb8'; this.style.textDecoration='underline'">View Responses (JSON)</a>
                <a href="/metrics" style="color: #005eb8; text-decoration: underline; margin-right: 24px; font-weight: bold;"
                   onmouseover="this.style.color='#7C2855'; this.style.textDecoration='none'" 
                   onmouseout="this.style.color='#005eb8'; this.style.textDecoration='underline'">Metrics</a>
                <a href="/health" style="color: #005eb8; text-decoration: underline; margin-right: 24px; font-weight: bold;"
                   onmouseover="this.style.color='#7C2855'; this.style.textDecoration='none'" 
                   onmouseout="this.style.color='#005eb8'; this.style.textDecoration='underline'">Health Check</a>
            </div>
        </div>
    </div>

    <footer style="background-color: #d8dde0; border-top: 4px solid #005eb8; padding: 20px; margin: 0 -10px;">
        <div style="max-width: 960px; margin: 0 auto; padding: 20px;">
            <p style="color: #212b32;">Â© NHS The Princess Alexandra Hospital NHS Trust</p>
        </div>
    </footer>

    <script>
        // Add cache busting parameter
        const CACHE_BUST = '?v=' + new Date().getTime();

        // Load questions from API
        async function loadQuestions() {
            try {
                const response = await fetch('/api/questions' + CACHE_BUST);
                const questions = await response.json();
                
                const container = document.getElementById('questionsContainer');
                const form = document.getElementById('surveyForm');
                const loading = document.getElementById('loading');
                
                // Add radio button styles once
                const radioStyles = document.createElement('style');
                radioStyles.textContent = `
                    .nhs-radio-item {
                        position: relative;
                        margin-bottom: 8px;
                        padding-left: 36px;
                        display: block;
                    }
                    .nhs-radio-input {
                        position: absolute;
                        z-index: 1;
                        top: 0;
                        left: 0;
                        width: 24px;
                        height: 24px;
                        opacity: 0;
                        cursor: pointer;
                    }
                    .nhs-radio-label {
                        font-weight: 400;
                        padding: 0;
                        cursor: pointer;
                        display: block;
                        font-size: 14pt;
                        font-family: 'Frutiger W01', Arial, sans-serif;
                    }
                    .nhs-radio-label::before {
                        content: "";
                        position: absolute;
                        top: 0;
                        left: 0;
                        width: 24px;
                        height: 24px;
                        border: 2px solid #425563;
                        border-radius: 50%;
                        background: #ffffff;
                        box-sizing: border-box;
                    }
                    .nhs-radio-label::after {
                        content: "";
                        position: absolute;
                        top: 6px;
                        left: 6px;
                        width: 12px;
                        height: 12px;
                        border-radius: 50%;
                        background: #005eb8;
                        opacity: 0;
                        transition: opacity 0.2s;
                    }
                    .nhs-radio-input:checked + .nhs-radio-label::after {
                        opacity: 1;
                    }
                    .nhs-radio-input:focus + .nhs-radio-label::before {
                        border-width: 4px;
                        box-shadow: 0 0 0 3px #ffeb3b;
                    }
                    .nhs-radio-input:hover + .nhs-radio-label::before {
                        border-color: #005eb8;
                    }
                `;
                document.head.appendChild(radioStyles);
                
                questions.forEach((question, index) => {
                    const questionDiv = document.createElement('div');
                    questionDiv.style.marginBottom = '32px';
                    questionDiv.style.padding = '24px';
                    questionDiv.style.border = '2px solid #E8EDEE';
                    questionDiv.style.borderRadius = '4px';
                    questionDiv.style.background = '#ffffff';
                    
                    const questionText = document.createElement('div');
                    questionText.style.fontWeight = 'bold';
                    questionText.style.marginBottom = '16px';
                    questionText.style.color = '#231f20';
                    questionText.style.fontSize = '19px';
                    questionText.innerHTML = `${index + 1}. ${question.question_text}${question.is_required ? '<span style="color: #8A1538;">*</span>' : ''}`;
                    
                    questionDiv.appendChild(questionText);
                    
                    if (question.question_type === 'multiple_choice' && question.options.length > 0) {
                        const radioGroup = document.createElement('div');
                        radioGroup.style.marginBottom = '24px';
                        
                        // Create radio buttons for ALL options
                        question.options.forEach(option => {
                            const radioItem = document.createElement('div');
                            radioItem.className = 'nhs-radio-item';
                            
                            const radioInput = document.createElement('input');
                            radioInput.className = 'nhs-radio-input';
                            radioInput.type = 'radio';
                            radioInput.name = `question_${question.question_id}`;
                            radioInput.value = option;
                            radioInput.id = `question_${question.question_id}_${option.replace(/\s+/g, '_')}`;
                            radioInput.required = question.is_required;
                            
                            const radioLabel = document.createElement('label');
                            radioLabel.className = 'nhs-radio-label';
                            radioLabel.htmlFor = radioInput.id;
                            radioLabel.textContent = option;
                            
                            radioItem.appendChild(radioInput);
                            radioItem.appendChild(radioLabel);
                            radioGroup.appendChild(radioItem);
                        });
                        
                        questionDiv.appendChild(radioGroup);
                    } else {
                        const formGroup = document.createElement('div');
                        formGroup.style.marginBottom = '24px';
                        
                        const input = document.createElement('input');
                        input.style.fontFamily = "'Frutiger W01', Arial, sans-serif";
                        input.style.fontSize = '14pt';
                        input.style.padding = '8px';
                        input.style.border = '2px solid #425563';
                        input.style.borderRadius = '4px';
                        input.style.width = '100%';
                        input.style.boxSizing = 'border-box';
                        input.type = 'text';
                        input.name = `question_${question.question_id}`;
                        input.placeholder = 'Enter your answer here...';
                        input.required = question.is_required;
                        input.onfocus = function() {
                            this.style.borderColor = '#005eb8';
                            this.style.boxShadow = 'inset 0 1px 1px rgba(0,0,0,.075), 0 0 8px rgba(0, 94, 184, .6)';
                        };
                        input.onblur = function() {
                            this.style.borderColor = '#425563';
                            this.style.boxShadow = 'none';
                        };
                        
                        formGroup.appendChild(input);
                        questionDiv.appendChild(formGroup);
                    }
                    
                    container.appendChild(questionDiv);
                });
                
                loading.style.display = 'none';
                form.style.display = 'block';
                
            } catch (error) {
                console.error('Error loading questions:', error);
                document.getElementById('loading').textContent = 'Error loading questions. Please refresh the page.';
                document.getElementById('loading').style.backgroundColor = '#8A1538';
                document.getElementById('loading').style.color = '#ffffff';
                document.getElementById('loading').style.padding = '16px';
                document.getElementById('loading').style.borderRadius = '4px';
                document.getElementById('loading').style.fontWeight = 'bold';
            }
        }

        // Handle form submission
        document.getElementById('surveyForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const answers = [];
            
            // Collect all answers
            for (let [name, value] of formData.entries()) {
                if (value.trim() !== '') {
                    const questionId = name.replace('question_', '');
                    answers.push({
                        question_id: parseInt(questionId),
                        answer_value: value
                    });
                }
            }
            
            try {
                const response = await fetch('/api/survey' + CACHE_BUST, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ answers: answers })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    document.getElementById('surveyForm').style.display = 'none';
                    document.getElementById('successMessage').style.display = 'block';
                    console.log('Survey submitted successfully:', result);
                } else {
                    throw new Error('Server error: ' + response.status);
                }
            } catch (error) {
                console.error('Error submitting survey:', error);
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('errorMessage').textContent = 'Error submitting survey: ' + error.message;
            }
        });

        // Load questions when page loads
        document.addEventListener('DOMContentLoaded', loadQuestions);
    </script>
</body>
</html>
