<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Patient Survey System</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/static/css/NHS-stylesheet-FX1.5.css?v=1"> 
    <style>
        body {
            font-family: 'Frutiger W01', Arial, sans-serif;
            font-size: 14pt;
            color: #231f20;
            background-color: #f0f4f5;
        }
        
        .Heading1 {
            font-family: 'Frutiger W01', arial, sans-serif;
            font-size: 28pt;
            font-weight: bold;
            color: #231f20;
        }
        
        .BlueBackground {
            background-color: #005eb8;
        }
        
        .TextFooter {
            color: #212b32;
        }
        
        .ButtonPrimary {
            background-color: #007f3b !important;
            color: #ffffff !important;
            border: none !important;
            border-radius: 4px !important;
            box-shadow: 0 4px 0 #00401e !important;
            padding: 12px 24px !important;
            font-size: 16px !important;
            font-weight: bold !important;
            cursor: pointer !important;
            outline: none !important;
        }
        
        .ButtonPrimary:hover {
            background-color: #00662f !important;
        }
        
        .ButtonPrimary:active {
            background-color: #00401e !important;
            box-shadow: none !important;
            transform: translateY(4px);
        }
        
        a {
            color: #005eb8;
            text-decoration: underline;
        }
        
        a:hover {
            color: #7C2855;
            text-decoration: none;
        }
        .container {
            max-width: 960px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header layout */
        .header-container {
            max-width: 960px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 80px;
        }
        
        .nhs-logo__svg {
            height: 40px;
            width: auto;
        }
        
        .paht-logo {
            height: 60px;
            width: auto;
            max-width: 200px;
            display: block;
        }
        
        .paht-logo-container {
            display: flex;
            align-items: center;
        }
        
        header {
            background-color: #005eb8 !important;
        }
        
        /* Survey specific styles */
        .survey-form {
            margin-bottom: 40px;
        }
        
        .question {
            margin-bottom: 32px;
            padding: 24px;
            border: 2px solid #E8EDEE;
            border-radius: 4px;
            background: #ffffff;
        }
        
        .question-text {
            font-weight: bold;
            margin-bottom: 16px;
            color: #231f20;
            font-size: 19px;
        }
        
        .required {
            color: #8A1538;
        }
        
        .form-group {
            margin-bottom: 24px;
        }
        
        .submit-button-container {
            text-align: right;
            margin-top: 30px;
            margin-bottom: 20px;
        }
        
        .nhs-input {
            font-family: 'Frutiger W01', Arial, sans-serif;
            font-size: 14pt;
            padding: 8px;
            border: 2px solid #425563;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
        }
        
        .nhs-input:focus {
            border-color: #005eb8 !important;
            box-shadow: inset 0 1px 1px rgba(0,0,0,.075), 0 0 8px rgba(0, 94, 184, .6);
        }
        
        /* Custom radio buttons to match NHS style */
        .nhs-radios__item {
            position: relative;
            margin-bottom: 8px;
            padding-left: 36px;
            display: block;
        }
        
        .nhs-radios__input {
            position: absolute;
            z-index: 1;
            top: 0;
            left: 0;
            width: 24px;
            height: 24px;
            opacity: 0;
        }
        
        .nhs-radios__label {
            font-weight: 400;
            padding: 0;
            cursor: pointer;
            display: block;
            font-size: 14pt;
        }
        
        .nhs-radios__label::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 24px;
            height: 24px;
            border: 2px solid #425563;
            border-radius: 50%;
            background: #ffffff;
        }
        
        .nhs-radios__label::after {
            content: "";
            position: absolute;
            top: 5px;
            left: 5px;
            width: 0;
            height: 0;
            border: 7px solid;
            border-radius: 50%;
            opacity: 0;
            background: #005eb8;
        }
        
        .nhs-radios__input:checked + .nhs-radios__label::after {
            opacity: 1;
        }
        
        .nhs-radios__input:focus + .nhs-radios__label::before {
            border-width: 4px;
            box-shadow: 0 0 0 3px #ffeb3b;
        }
        
        /* Navigation links */
        .nav-links {
            margin-top: 40px;
            padding-top: 24px;
            border-top: 1px solid #E8EDEE;
        }
        
        .nav-links a {
            color: #005eb8;
            text-decoration: underline;
            margin-right: 24px;
            font-weight: bold;
        }
        
        .nav-links a:hover {
            color: #7C2855;
            text-decoration: none;
        }
        
        .nav-links a:active {
            background-color: #ffeb3b;
            color: #212b32;
            border: none;
            box-shadow: 0 -2px #ffeb3b, 0 4px #212b32;
            text-decoration: none;
        }
        
        /* Loading and message styles */
        #loading {
            padding: 24px;
            text-align: center;
            font-size: 14pt;
        }
        
        .success-message {
            background-color: #007f3b;
            color: #ffffff;
            padding: 16px;
            margin-bottom: 32px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .error-message {
            background-color: #8A1538;
            color: #ffffff;
            padding: 16px;
            margin-bottom: 32px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        /* NHS Button fallback styles */
        .ButtonPrimary, .nhs-button {
            background-color: #007f3b !important;
            color: #ffffff !important;
            border: none !important;
            border-radius: 4px !important;
            box-shadow: 0 4px 0 #00401e !important;
            padding: 12px 24px !important;
            font-size: 16px !important;
            font-weight: bold !important;
            cursor: pointer !important;
            outline: none !important;
        }
        
        .ButtonPrimary:hover, .nhs-button:hover {
            background-color: #00662f !important;
        }
        
        .ButtonPrimary:active, .nhs-button:active {
            background-color: #00401e !important;
            box-shadow: none !important;
            transform: translateY(4px);
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }
            
            .header-container {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .question {
                padding: 16px;
            }
            
            .nav-links a {
                display: block;
                margin-bottom: 16px;
            }
        }
    </style>
</head>
<body>
    <header style="background-color: #005eb8; padding: 12px 0;">
        <div class="header-container">
            <div class="nhs-logo">
                <a href="/" aria-label="NHS homepage">
                    <svg class="nhs-logo__svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 16" height="40" width="100">
                        <path fill="#ffffff" d="M3.9 1.5h4.4l2.6 9h.1l1.8-9h3.3l-2.8 13H9l-2.7-9h-.1l-1.8 9H1.1M17.3 1.5h3.6l-1 4.9h4L25 1.5h3.5l-2.7 13h-3.5l1.1-5.6h-4.1l-1.2 5.6h-3.4M37.7 4.4c-.7-.3-1.6-.6-2.9-.6-1.4 0-2.5.4-2.5 1.3 0 1.8 5.1 1.2 5.1 5.1 0 3.6-3.3 4.5-6.4 4.5-1.3 0-2.9-.3-4-.7l.8-2.7c.7.4 2.1.7 3.2.7 1.6 0 2.8-.4 2.8-1.4 0-2.1-5.1-1.3-5.1-5 0-3.4 2.9-4.4 5.8-4.4 1.2 0 2.7.2 3.8.7"></path>
                    </svg>
                </a>
            </div>
            <div class="paht-logo-container">
                <img src="/static/images/PAHT-logo.png" 
                     alt="The Princess Alexandra Hospital NHS Trust" 
                     class="paht-logo">
            </div>
        </div>
    </header>
    
    <div class="ndl-body">
        <div class="container">
            <h1 class="Heading1">Patient Experience Survey</h1>
            
            <!-- Test if NHS CSS is loading -->
            <div class="BlueBackground" style="padding: 10px; margin: 10px 0;">
                <span style="color: white;">If this is blue, NHS CSS is working</span>
            </div>
            
            <div id="loading">Loading survey questions...</div>
            
            <form id="surveyForm" class="survey-form" style="display: none;">
                <div id="questionsContainer"></div>
                
                <div class="submit-button-container">
                    <button type="submit" class="ButtonPrimary">Submit Survey</button>
                </div>
            </form>

            <div id="successMessage" class="success-message" style="display: none;" role="alert">
                Thank you for completing the survey! Your feedback has been recorded.
            </div>

            <div id="errorMessage" class="error-message" style="display: none;" role="alert">
                There was an error submitting your survey. Please try again.
            </div>

            <div class="nav-links">
                <a href="/api/questions">View Questions (JSON)</a>
                <a href="/api/responses">View Responses (JSON)</a>
                <a href="/metrics">Metrics</a>
                <a href="/health">Health Check</a>
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <p class="TextFooter">Â© NHS The Princess Alexandra Hospital NHS Trust</p>
        </div>
    </footer>

    <script>
        // Add cache busting parameter
        const CACHE_BUST = '?v=' + new Date().getTime();

        // Load questions from API
        async function loadQuestions() {
            try {
                const response = await fetch('/api/questions' + CACHE_BUST);
                const questions = await response.json();
                
                const container = document.getElementById('questionsContainer');
                const form = document.getElementById('surveyForm');
                const loading = document.getElementById('loading');
                
                questions.forEach((question, index) => {
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'question';
                    
                    const questionText = document.createElement('div');
                    questionText.className = 'question-text';
                    questionText.innerHTML = `${index + 1}. ${question.question_text}${question.is_required ? '<span class="required">*</span>' : ''}`;
                    
                    questionDiv.appendChild(questionText);
                    
                    if (question.question_type === 'multiple_choice' && question.options.length > 0) {
                        const radioGroup = document.createElement('div');
                        radioGroup.className = 'form-group';
                        
                        question.options.forEach(option => {
                            const radioItem = document.createElement('div');
                            radioItem.className = 'nhs-radios__item';
                            
                            const radioInput = document.createElement('input');
                            radioInput.className = 'nhs-radios__input';
                            radioInput.type = 'radio';
                            radioInput.name = `question_${question.question_id}`;
                            radioInput.value = option;
                            radioInput.id = `question_${question.question_id}_${option.replace(/\s+/g, '_')}`;
                            radioInput.required = question.is_required;
                            
                            const radioLabel = document.createElement('label');
                            radioLabel.className = 'nhs-radios__label';
                            radioLabel.htmlFor = radioInput.id;
                            radioLabel.textContent = option;
                            
                            radioItem.appendChild(radioInput);
                            radioItem.appendChild(radioLabel);
                            radioGroup.appendChild(radioItem);
                        });
                        
                        questionDiv.appendChild(radioGroup);
                    } else {
                        const formGroup = document.createElement('div');
                        formGroup.className = 'form-group';
                        
                        const input = document.createElement('input');
                        input.className = 'nhs-input';
                        input.type = 'text';
                        input.name = `question_${question.question_id}`;
                        input.placeholder = 'Enter your answer here...';
                        input.required = question.is_required;
                        
                        formGroup.appendChild(input);
                        questionDiv.appendChild(formGroup);
                    }
                    
                    container.appendChild(questionDiv);
                });
                
                loading.style.display = 'none';
                form.style.display = 'block';
                
            } catch (error) {
                console.error('Error loading questions:', error);
                document.getElementById('loading').textContent = 'Error loading questions. Please refresh the page.';
                document.getElementById('loading').className = 'error-message';
            }
        }

        // Handle form submission
        document.getElementById('surveyForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const answers = [];
            
            // Collect all answers
            for (let [name, value] of formData.entries()) {
                if (value.trim() !== '') {
                    const questionId = name.replace('question_', '');
                    answers.push({
                        question_id: parseInt(questionId),
                        answer_value: value
                    });
                }
            }
            
            try {
                const response = await fetch('/api/survey' + CACHE_BUST, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ answers: answers })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    document.getElementById('surveyForm').style.display = 'none';
                    document.getElementById('successMessage').style.display = 'block';
                    console.log('Survey submitted successfully:', result);
                } else {
                    throw new Error('Server error: ' + response.status);
                }
            } catch (error) {
                console.error('Error submitting survey:', error);
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('errorMessage').textContent = 'Error submitting survey: ' + error.message;
            }
        });

        // Load questions when page loads
        document.addEventListener('DOMContentLoaded', loadQuestions);
    </script>
</body>
</html>
